# 实体之间如何传递消息？

## 为什么传递消息

实体之间有时会需要相互传递信息（消息）。典型场景包括：

* 雷达将侦察结果直接传递给打击设备，引导打击设备瞄准目标

* 雷达将侦察结果（消息）传递给指挥控制设备，指挥控制设备对侦察结果进行处理

* 指控设备将指令（消息）传递给打击设备，引导打击设备进行操作


## 消息机制是必须的么？

有没有另外一种方法，可以实现对象之间的信息交互？

消息机制是对现实世界中信息传递方式一种最直观的抽象。

如果没有消息机制，就需要让两个实体（或者通过一个中间实体）互相操作，耦合性太强。

消息机制将消息内容和消息的处理解耦，方便处理。


## 消息及其分类

根据上述情况，消息通常具有以下特点：

* 有明确的 **发送者** 和 **接收者**

* 消息的内容是多样的，从形式上要能容纳各种类型的信息


## 消息的传递与处理

### 消息的发送

从使用方式上看，每个实体应该调用一个发送消息方法，就可以将消息发送至当前场景，由当前场景负责将消息转发目标实体.

在这种模式下，场景就相当于一个邮局，发送方只需要将信件（消息）交给邮局，填好信件相关信息，剩下的事由邮局负责处理.

``` python
sender = Entity()
target = Entity()

sender.send_msg(target.name, msg)  # 通过名字发送消息
sender.send_msg(target.id, msg)  # 通过 id 发送消息
sender.send_msg(target, msg)  # 通过对象发送消息
```

### 消息的接收与处理

与消息发送相对应，实体也应该有消息接收和处理接口（方法）。这个方法应该是由场景调用：场景在有需要转发的消息时，调用实体的消息接收/处理接口，通知实体处理消息.

```python
target.recv_msg(sender, msg)
```

为了避免出现消息循环，通常情况下，在消息接收处理过程中，应避免再次发送消息. （TODO: 有没有一种机制，强制再次发送的消息自动放入下一步对应的消息队列中？）


### 消息的时序性



### 接收者的指向性

通常，发送者和接收者是一对一的关系。

还没有确定，是否支持以下关系：

* 一对多

* 全局广播

***

# 关于主程序循环

场景中，一次循环包括以下典型动作：

1. **时钟前进**：确定当前时间基准  

2. **实体步进**：将状态更新到当前时间基准

3. **实体相互交互**：根据最新状态，相互交互

4. **处理步进消息**：

5. **实体消息处理**：


## 时钟前进.

为场景确定以下参考内容：

* 当前时间：作为当前循环时间。

* 从上一个时间前进到当前时间经历的时长。

``` python
tt = clock.step()
# now, dt = tt
```

## 实体步进.

各个（活动的）实体步进到当前循环时间。确保当前状态已经更新到当前时间。

``` python
for obj in active_entities:
    obj.step(tt)
```

## 实体相互交互.

各个实体根据最新的状态，相互交互，进一步更新各自的状态。

值得注意的是，实体在交互时会改变自己的状态，为了在交互更新时不形成循环依赖，需要构建**影子**实体，以影子实体作为交互的对象，确保不出现错误。

``` python
shadow_entities = copy.deepcopy(active_entities)

for obj in active_entities:
    others = [e for e in shadow_entities if e.id != obj.id]
    obj.access(others)
```


## 处理步进消息

步进消息用于在每一步给场景/实体执行某些处理的机会。

实体根据当前时刻（最新）状态，进行一些操作。（通常这类操作不应该影响/改变实体的状态？！）


## 实体消息处理

实体接收和处理其他实体发送的消息，按照需要 **更新状态** 或者 **执行某些操作** 。


## 几个问题


### 步进和交互的先后问题


目前是这么考虑的：交互时，实体应该处于自己的最新状态，所以应该先步进，后交互。


